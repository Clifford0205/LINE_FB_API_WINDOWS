<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="./content/css/all.css">
    <title>Document</title>

    <style>

    </style>
</head>

<body>
    <div class="container">
        <div class="row the-area">
            <div class="col d-flex align-items-center justify-content-center">

                <div class="member-popup">
                    <div class="card-info">
                        <h2 class="text-center">請完成以下資訊</h2>
                        <form action="" method="post" name="form1" onsubmit="return checkForm();">

                            <div class="d-flex justify-content-center">
                                <div class="theinput ">
                                    暱稱<input type="text" name="nickname" class="card  nickname w-100">
                                </div>
                            </div>



                            <div class="d-flex justify-content-center mt-3">
                                <div class="theinput ">
                                    e-mail*<input type="text" name="email" class="w-100 email" required>
                                </div>
                            </div>
                            <div id="emailHelp" class="text-center " style="color:red"> </div>
                            <button type="submit" class="mx-auto d-block submitbtn mt-5">確認</button>
                        </form>


                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>

    let mymail = "";

    let nickname = "";

    let whatapp = location.search.slice(1, 5);

    let myid = location.search.slice(9).split("&")[0];

    let name = location.search.split('name')[1].slice(1);

    let truename = decodeURI(name);


    console.log(myid);

    console.log(whatapp);

    console.log(name);

    console.log(truename);

    if (truename) {
        document.querySelector('.nickname').value = truename;
    }

    const checkForm = () => {
        let isPassed = true;

        mymail = document.querySelector('.email').value;
        nickname = document.querySelector('.nickname').value;

        let email_pattern = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;

        if (!email_pattern.test(mymail)) {
            document.querySelector('#emailHelp').innerHTML = '請填寫正確的 Email!';
            isPassed = false;
        }

        if (whatapp === "myfb") {
            if (isPassed) {
                axios({
                    method: 'post',
                    url: 'http://localhost:5555/line',
                    data: {
                        email: mymail,
                        nickname: nickname,
                        myfb_id: myid,
                        line_id: "",
                        cardno: "",
                        mobile: "",
                    },
                })
                    .then(res => { window.location.href = 'success.html'; })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
        } else {
            if (isPassed) {
                axios({
                    method: 'post',
                    url: 'http://localhost:5555/line',
                    data: {
                        email: mymail,
                        nickname: nickname,
                        line_id: myid,
                        myfb_id: "",
                        cardno: "",
                        mobile: "",
                    },
                })
                    .then(res => { window.location.href = 'success.html'; })
                    .catch(function (error) {
                        console.log(error);
                    });
            }

        }

        return false;

    }


</script>

</html>